<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;

class PreventMassAssignmentVulnerability
{
    // fields that users should never be able to change
    private array $protectedFields = [
        'role',
        'user_id',
        'id',
        'created_at',
        'updated_at',
        'email_verified_at',
        'remember_token',
    ];

    public function handle(Request $request, Closure $next): Response
    {
        if ($request->isJson() || $request->ajax()) {
            $input = $request->all();
            
            foreach ($this->protectedFields as $field) {
                if (array_key_exists($field, $input)) {
                    logger()->warning('mass assignment attempt detected', [
                        'user_id' => auth()->id(),
                        'field' => $field,
                        'ip' => $request->ip(),
                        'route' => $request->path(),
                    ]);

                    $request->request->remove($field);
                }
            }
        }

        return $next($request);
    }
}
